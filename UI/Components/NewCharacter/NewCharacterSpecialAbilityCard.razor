@using Models.Characters
@using Models.Settings;
@using Persistence.Json
@inject ILoader Loader

<MudCard Outlined="true">
	<MudCardHeader>
		<MudText>Choose a special ability</MudText>
	</MudCardHeader>
	<MudCardContent>
		<MudText>If you're unsure which one to pick, the first is considered a good default choice.</MudText>
		<MudSelect T="PlaybookSpecialAbility" Value="ChosenAbility" ValueChanged="OnChosenAbilityChanged" Label="Special Ability" >
			@foreach (var ability in AvailableAbilities)
			{
				<MudSelectItem T="PlaybookSpecialAbility" Value="ability">
					<MudText>@DisplayText(ability)</MudText>
					<MudText>@ability.Description</MudText>
				</MudSelectItem>
			}
		</MudSelect>
		@foreach(var ability in Playbook.Abilities)
		{
			<MudText>@ability.Description</MudText>
		}
	</MudCardContent>
</MudCard>

@code
{
	[Parameter, EditorRequired]
	public Playbook Playbook { get; set; } = Playbook.Empty();

	[Parameter, EditorRequired]
	public GameSetting? GameSetting { get; set; }

	public PlaybookSpecialAbility[] AvailableAbilities { get; private set; } = new PlaybookSpecialAbility[0];

	private PlaybookSpecialAbility? ChosenAbility { get; set; }

	private void OnChosenAbilityChanged(PlaybookSpecialAbility value)
	{
		Playbook.ClearAbilities();
		ChosenAbility = value;
		Playbook.TakeAbility(ChosenAbility);
	}

	protected override void OnInitialized()
	{
		AvailableAbilities = GameSetting!.GetPlaybookSetting(Playbook.Name)
			.GetAvailableAbilities();

		base.OnInitialized();
	}

	public static string DisplayText(PlaybookSpecialAbility ability) =>
		ability.TimesTakeable == 1 ? ability.Name
		: $"{ability.Name} (take once of {ability.TimesTakeable} possible times)";
}
